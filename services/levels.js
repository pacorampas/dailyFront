if(localStorage.dev === undefined){
console.log('Fake data gogogo ;)');
localStorage.levels = '[{"id":1,"value":"nivel primero","expressions":[{"id":1,"value":"value expression primera","explanation":"explicación expresión primera","contexts":[{"id":1,"value":"contexto uno expresión primera","answers":["respuesta uno contexto uno expresión primera","respuesta dos contexto uno expresión primera"]}]},{"id":2,"value":"value expression segunda","explanation":"explicación expresión segunda","contexts":[{"id":2,"value":"contexto uno expresión segunda","answers":["respuesta uno contexto uno expresión segunda","respuesta dos contexto uno expresión segunda"]}]},{"id":3,"value":"value expression tercera","explanation":"explicación expresión tercera","contexts":[{"id":3,"value":"contexto uno expresión tercera","answers":["respuesta uno contexto uno expresión tercera","respuesta dos contexto uno expresión tercera"]}]}]},{"id":2,"value":"nivel segundo","expressions":[{"id":4,"value":"value expression cuarta","explanation":"explicación expresión cuarta","contexts":[{"id":4,"value":"contexto uno expresión cuarta","answers":["respuesta uno contexto uno expresión cuarta","respuesta dos contexto uno expresión cuarta"]}]},{"id":5,"value":"value expression quinta","explanation":"explicación expresión quinta","contexts":[{"id":5,"value":"contexto uno expresión quinta","answers":["respuesta uno contexto uno expresión quinta","respuesta dos contexto uno expresión quinta"]}]},{"id":6,"value":"value expression sexta","explanation":"explicación expresión sexta","contexts":[{"id":6,"value":"contexto uno expresión sexta","answers":["respuesta uno contexto uno expresión sexta","respuesta dos contexto uno expresión sexta"]}]}]},{"id":3,"value":"nivel tercero","expressions":[{"id":7,"value":"value expression septima","explanation":"explicación expresión septima","contexts":[{"id":7,"value":"contexto uno expresión septima","answers":["respuesta uno contexto uno expresión septima","respuesta dos contexto uno expresión septima"]}]},{"id":8,"value":"value expression octava","explanation":"explicación expresión octava","contexts":[{"id":8,"value":"contexto uno expresión octava","answers":["respuesta uno contexto uno expresión octava","respuesta dos contexto uno expresión octava"]}]},{"id":9,"value":"value expression novena","explanation":"explicación expresión novena","contexts":[{"id":9,"value":"contexto uno expresión novena","answers":["respuesta uno contexto uno expresión novena","respuesta dos contexto uno expresión novena"]}]}]}]';
localStorage.allLevels = '[{"id":4,"value":"nivel cuarto","expressions":[{"id":10,"value":"value expression décina","explanation":"explicación expresión décima","contexts":[{"id":10,"value":"contexto uno expresión décima","answers":["respuesta uno contexto uno expresión décima","respuesta dos contexto uno expresión décima"]}]},{"id":11,"value":"value expression 11","explanation":"explicación expresión 11","contexts":[{"id":11,"value":"contexto uno expresión 11","answers":["respuesta uno contexto uno expresión 11","respuesta dos contexto uno expresión 11"]}]},{"id":12,"value":"value expression 12","explanation":"explicación expresión 12","contexts":[{"id":12,"value":"contexto uno expresión 12","answers":["respuesta uno contexto uno expresión 12","respuesta dos contexto uno expresión 12"]}]}]},{"id":5,"value":"nivel quinto","expressions":[{"id":13,"value":"value expression 13","explanation":"explicación expresión 13","contexts":[{"id":13,"value":"contexto uno expresión 13","answers":["respuesta uno contexto uno expresión 13","respuesta dos contexto uno expresión 13"]}]},{"id":14,"value":"value expression 14","explanation":"explicación expresión 14","contexts":[{"id":14,"value":"contexto uno expresión 14","answers":["respuesta uno contexto uno expresión 14","respuesta dos contexto uno expresión 14"]}]},{"id":15,"value":"value expression 15","explanation":"explicación expresión 15","contexts":[{"id":15,"value":"contexto uno expresión 15","answers":["respuesta uno contexto uno expresión 15","respuesta dos contexto uno expresión 15"]}]}]},{"id":6,"value":"nivel sexto","expressions":[{"id":16,"value":"value expression 16","explanation":"explicación expresión 16","contexts":[{"id":16,"value":"contexto uno expresión 16","answers":["respuesta uno contexto uno expresión 16","respuesta dos contexto uno expresión 16"]}]},{"id":17,"value":"value expression 17","explanation":"explicación expresión 17","contexts":[{"id":17,"value":"contexto uno expresión 17","answers":["respuesta uno contexto uno expresión 17","respuesta dos contexto uno expresión 17"]}]},{"id":18,"value":"value expression 18","explanation":"explicación expresión 18","contexts":[{"id":18,"value":"contexto uno expresión 18","answers":["respuesta uno contexto uno expresión 18","respuesta dos contexto uno expresión 18"]}]}]}]';

//real expressions
localStorage.levels = '[{"id":1,"value":"nivel primero","expressions":[{"id":1,"value":"Beat around the bush","explanation":"Be deliberately ambiguous or unclear in order to mislead or withhold information","contexts":[{"id":1,"value":"She doesn\'t talk about the core issue. She is trying to deflect attention from the main topic","answers":["She is beating around the bush","She\'s beating around the bush"]}]},{"id":2,"value":"Oh my God!","explanation":"An exclamation of shock or surprise, often used repeatedly by people who are shocked and surprised by almost everything and insert it into conversations whenever possible","contexts":[{"id":2,"value":"-Do you know what? -What? -I have seen the Johnson\'s pretty little girl with an old and ugly man.","answers":["Oh my God!"]}]},{"id":3,"value":"The last straw that breaks the camel\'s back","explanation":"The last in a series of unpleasant events which finally makes you feel that you cannot continue to accept a bad situation","contexts":[{"id":3,"value":"Losing my job was bad enough, but having the relationship end like that...","answers":["was the last straw that broke the camel\'s back"]}]}]},{"id":2,"value":"nivel segundo","expressions":[{"id":4,"value":"Leave me alone","explanation":"A rude way of telling people to give you some space and to not bother","contexts":[{"id":4,"value":"I need to think about things, so…","answers":["leave me alone"]}]},{"id":5,"value":"Let the cat out of the bag","explanation":"Reveal a secret or a surprise by accident","contexts":[{"id":5,"value":"I\'m going to tell Rose that I\'m in love with her, but don\'t tell anything please, it\'s a secret. Try not to…","answers":["let the cat out of the bag"]}]},{"id":6,"value":"Let’s have one for the road","explanation":"If you have one for the road, you have a drink, usually an alcoholic drink, before you start a journey or before leaving a bar","contexts":[{"id":6,"value":"-Hey guys, the bar is going to close in 10 minutes, so…","answers":["let’s have one for the roa"]}]}]},{"id":3,"value":"nivel tercero","expressions":[{"id":7,"value":"Make yourself at home","explanation":"Relax and make yourself comfortable in someone else\'s homea","contexts":[{"id":7,"value":"-Hi! I hope I\'m not too early. -Not at all. Come in and...","answers":["make yourself at home"]}]},{"id":8,"value":"No wonder","explanation":"This idiom means that it\'s not surprising","contexts":[{"id":8,"value":"This is the first time the children have been abroad, ... they are excited","answers":["no wonder"]}]},{"id":9,"value":"Pissed as a newt","explanation":"A colloquial expression in the UK for someone who is very drunk","contexts":[{"id":9,"value":"Look at Mike, he has drunk the bottle all alone, he\'s as…","answers":["pissed as a newt"]}]}]}]';
localStorage.allLevels = '[{"id":4,"value":"nivel cuarto","expressions":[{"id":10,"value":"Pull the other one","explanation":"It\'s use to tell someone that you do not believe what they have just said","contexts":[{"id":10,"value":"-Yeah I drank about 20 beers but the cop couldn\'t tell I was drunk and let me go. -I don\'t think so...","answers":["pull the other one"]}]},{"id":11,"value":"Same here","explanation":"Said when you agree with what has been said or you have experienced the same thing as they have","contexts":[{"id":11,"value":"I\'ll have chocolate ice cream! -Yes,...","answers":["same here"]}]},{"id":12,"value":"Say when","explanation":"Tell me when I have given you enough of something, usually a liquid. (Sometimes answered simply with When.)","contexts":[{"id":12,"value":"-Do you want some more juice? -Yes. -Okay,... -When.","answers":["say when"]}]}]},{"id":5,"value":"nivel quinto","expressions":[{"id":13,"value":"Talk of the devil","explanation":"Talk about a certain person, and that person appears. (Used when someone appears whom you have just been talking about.)","contexts":[{"id":13,"value":"-I haven\'t seen Bob for weeks. -Look, here comes Bob right now. -Well,...","answers":["talk of the devil"]}]},{"id":14,"value":"Ten-Bob","explanation":"UK - Fifty pence (50p). Half a pound Sterling (100 pence). Fifty Pennies.","contexts":[{"id":14,"value":"-Oi Steve, have you got a ... bit for the pool-table?","answers":["Ten-Bob"]}]},{"id":15,"value":"Pay cash","explanation":"Pay money in the form of bills or coins; currency","contexts":[{"id":15,"value":"-How much is it? -25 pounds. Will you ... or with a credit card?","answers":["pay cash"]}]}]},{"id":6,"value":"nivel sexto","expressions":[{"id":16,"value":"You’re kidding","explanation":"Used to express disbelief when someone has said something that you think is ridiculous or completely untrue","contexts":[{"id":16,"value":"-I have to go home. It\'s late. -Now? ...","answers":["You are kidding","You\'re kidding"]}]},{"id":17,"value":"You’re welcome","explanation":"Usually used as an answer to someone saying thank you","contexts":[{"id":17,"value":"-Thanks for returning the video. -Oh, ...","answers":["You are welcome","You\'re welcome"]}]},{"id":18,"value":"You’re pulling my leg","explanation":"Tell someone something that is not true as a way of joking with them (usually in continuous tenses)","contexts":[{"id":18,"value":"-Is he really angry with me or do you think...?","answers":["She is pulling my leg","She\'is pulling my leg"]}]}]}]';
}

var levelsService = (function(){
	var levels = localStorage.levels ? JSON.parse(localStorage.levels) : [];

	function getLastLevel(){
		return levels[levels.length-1];
	}

	function getLevel(idLevel) {
		for(var i = 0, l = levels.length; i < l; i++){
			if(levels[i].id == idLevel) {
				return levels[i];
			}
		}
		console.log('Not exist this level');
		return false;
	}

	function getExpression(idLevel, idExpression) {
		var level = getLevel(idLevel);

		if(!level){
			return false;
		}
		
		for(var i = 0, l = level.expressions.length; i < l; i++){
			if(level.expressions[i].id == idExpression){
				return level.expressions[i];
			}
		}

		console.log('Not exist this expression into this level');
		return false;
	}

	function pullLevel(currentIdLevel){
		fakeServerRequest(currentIdLevel, function(newLevel){
			if(!newLevel){
				console.log('Level no encontrado en el servidor');
				return;
			}
			levels.push(newLevel);
			localStorage.levels = JSON.stringify(levels);
			dispatchEventAddedNewLevel();
		});
	}

	function fakeServerRequest(currentIdLevel, callback){
		if(callback === undefined){
			console.log('ERR: No callback');
			return;
		}
		var serverLevels = JSON.parse(localStorage.allLevels);
		var id = currentIdLevel+1;
		setTimeout(function(){
			for(var i = 0; i < serverLevels.length; i++){
				if(serverLevels[i].id == id){
					callback(serverLevels[i]);
					return;
				}
			}
			callback(false);
		}, 1000);
	}

	function dispatchEventAddedNewLevel(){
		var addedNewLevel = document.createEvent('Event');
    	addedNewLevel.initEvent('addedNewLevel', true, true);

		document.dispatchEvent(addedNewLevel);
	}

	return {
		getExpression: getExpression,
		getLastLevel: getLastLevel,
		pullLevel: pullLevel
	}

}());

if(localStorage.dev === undefined){
localStorage.actives = '{"1":{"idExpression":1,"idLevel":1,"created":"Wed Aug 10 2014 20:18:32 GMT+0200","errors":["2014-08-23T11:13:28.735Z"],"correct":"2014-08-23T13:51:37.285Z"},"2":{"idExpression":2,"idLevel":1,"created":"2014-08-26T18:48:22.110Z","errors":[],"correct":false},"3":{"idExpression":3,"idLevel":1,"created":"2014-08-26T18:54:08.682Z","errors":["2014-08-28T18:42:37.696Z"],"correct":"2014-08-28T18:43:02.281Z"},"4":{"idExpression":4,"idLevel":2,"created":"2014-09-13T08:50:06.115Z","errors":[],"correct":null},"5":{"idExpression":5,"idLevel":2,"created":"2014-09-08T15:21:11.078Z","errors":[],"correct":null},"6":{"idExpression":6,"idLevel":2,"created":"2014-09-11T09:50:10.084Z","errors":[],"correct":null},"7":{"idExpression":7,"idLevel":3,"created":"2014-09-11T09:50:10.084Z","errors":[],"correct":"2014-09-08T15:21:11.078Z"},"8":{"idExpression":8,"idLevel":3,"created":"2014-10-11T09:50:10.084Z","errors":[],"correct":"2014-10-08T15:21:11.078Z"},"9":{"idExpression":9,"idLevel":3,"created":"2015-11-03T09:50:10.084Z","errors":[],"correct":"2014-09-08T15:21:11.078Z"}}';
localStorage.daily = '{"idLevel":3,"idExpression":9}';
localStorage.notActives = '{"1":[],"2":[],"3":[],"active":3}';
}
var activesService = (function(){
	var actives = localStorage.actives ? JSON.parse(localStorage.actives) : {};
	var notActives = localStorage.notActives ? JSON.parse(localStorage.notActives) : [];
	var daily = localStorage.daily ? JSON.parse(localStorage.daily) : {};

	function getActive(idExpression) {
		return actives[idExpression];
	}

	function getActives(){
		return actives;
	}

	function updateActive(idExpression, correct){
		var date = new Date();
		if(correct){
			actives[idExpression].correct = date;
		} else {
			actives[idExpression].errors.push(date);
		}
		var eventData = {
			'correct': correct, 
			'idExpression': idExpression, 
			'date': date
		};
		saveData(eventData);
	}

	function getExressionByIdActive(idExpression) {
		var active = getActive(idExpression);
		if(!active){
			console.log('Not exit any active by this idExpression');
			return false;
		}
		return levelsService.getExpression(active.idLevel, active.idExpression);
	}

	function getDaily(){
		return getExressionByIdActive(daily.idExpression);
	}

	function createDaily(){
		if( isTodayDaily() ){
			//daily
			return getExressionByIdActive(daily.idExpression);
		}else{
			//generate daily
			return generateDaily();
		}
	}

	function isTodayDaily(){
		var active = getActive(daily.idExpression);
		var today = new Date();
		var dateDaily = new Date(active.created);

		if( dateDaily.setHours(0,0,0,0) == today.setHours(0,0,0,0) ){
			return true;
		}else{
			return false;
		}
	}

	function getDailyActive (){
		return getActive(daily.idExpression);
	}

	function generateDaily(){
		var idLevelActive = notActives.active;
		var levelActive = notActives[idLevelActive];
		
		if(levelActive.length <= 0){
			console.log('¡¡¡Necesitas descargar un nuevo nivel!!!');
			levelsService.pullLevel(idLevelActive);
			return false;
		}

		var todayExpressionId = levelActive.pop();
		generateActive(idLevelActive, todayExpressionId);
		//activamos alarma de practicar
		alarmService.setPracticeAlarm();
		alarmService.cancellAlarmById(0);
		if(levelActive.length < 1){
			console.log('¡¡¡Pedir nuevo nivel al server!!!');
			levelsService.pullLevel(idLevelActive);
		}
		saveData();
		return getExressionByIdActive(todayExpressionId);
	}

	function generateActive(idLevel, idExpression){
		var newActive = new Object();
		newActive.idExpression = idExpression;
		newActive.idLevel = idLevel;
		newActive.created = new Date();
		newActive.errors = new Array();
		newActive.correct = null;
		actives[newActive.idExpression] = newActive;
		daily['idLevel'] = idLevel;
		daily['idExpression'] = idExpression;
	}

	function saveData(eventData){
		localStorage.actives = JSON.stringify(actives);
		localStorage.notActives = JSON.stringify(notActives);
		localStorage.daily = JSON.stringify(daily);
		var detail = null;
		if(eventData !== undefined){
			detail = eventData;
		}
		dispatchEventUploadedActives(eventData);
		console.log('Upload actives data');
	}

	function errors(){
		var errors = [];
		var activeDaily = getActive(daily.idExpression);
		
		for( key in actives ) {
			if(!actives[key].correct){
				if(actives[key].idExpression != daily.idExpression ||  actives[key].idExpression == daily.idExpression && activeDaily.errors.length > 0){
					var idExpression = actives[key].idExpression;
					errors.push(idExpression);
				}	
			}
		}
		return errors;
	}

	function dispatchEventUploadedActives(eventData){
		var detail = null;
		if(eventData !== undefined){
			detail = eventData;
		}

		var uploadedActives = document.createEvent('Event');
		uploadedActives.detail = detail;
    	uploadedActives.initEvent('uploadedActives', true, true);

		document.dispatchEvent(uploadedActives);
	}

	function dispatchEventRefreshDaily(){
		var refreshDaily = document.createEvent('Event');
    	refreshDaily.initEvent('refreshDaily', true, true);

		document.dispatchEvent(refreshDaily);
	}
	
	document.addEventListener('addedNewLevel', function(){
		var lastLevel = levelsService.getLastLevel();
		if(notActives.active == lastLevel.id){
			console.log('This level is already active');
			return;
		}
		notActives[lastLevel.id] = [];
		notActives.active = lastLevel.id;
		var expressions = lastLevel.expressions;

		for(var i = 0; i < expressions.length; i++){
			notActives[lastLevel.id].unshift(expressions[i].id);
		}
		saveData();
		if( !isTodayDaily() ){
			dispatchEventRefreshDaily();
		}
	})

	return {
		getActives: getActives,
		daily: daily,
		errors: errors,
		getActive: getActive,
		getExressionByIdActive: getExressionByIdActive,
		getDaily: getDaily,
		createDaily: createDaily,
		getDailyActive: getDailyActive,
		updateActive: updateActive
	}

}(levelsService));

if(localStorage.dev === undefined){
localStorage.life = 3;
}
var practiceService = (function(){
	var life = localStorage.life ? localStorage.life : 0;
	var errors = activesService.errors();
	
	document.addEventListener('uploadedActives', function(){
		errors = activesService.errors();
	});

	function getErrors(){
		return errors;
	}

	function saveData(){
		if(localStorage.life == life){
			return;
		}
		localStorage.life = life;
		console.log('Uploaded Life data');
		document.dispatchEvent(uploadedLifes);
	}

	function addLife(){
		life++;
		if(life > 3){
			life = 3;
		}
		saveData();		
		return life;
	}

	function removeLife(){
		life--;
		if(life < 0){
			life = 0;
		}
		saveData();		
		return life;
	}

	function getLifes(){
		return life;
	}

	function calculatePassed(){
		var actives = activesService.getActives();
		var dailyActive = activesService.getDailyActive();
		if(dailyActive.errors.length > 0 || dailyActive.correct){
			return Object.keys(actives).length - errors.length;
		}else{
			return Object.keys(actives).length - errors.length - 1;
		}
	}

	function errorDaily(){
		if(errors.length <= 0){
			console.log('There is not errors');
			return false;
		}

		var rand = Math.floor((Math.random() * errors.length));
		return activesService.getExressionByIdActive(errors[rand]);	
	}

	var uploadedLifes = document.createEvent('Event');
    uploadedLifes.initEvent('uploadedLifes', true, true);

	return {
		getLifes: getLifes,
		calculatePassed: calculatePassed,
		addLife: addLife,
		removeLife: removeLife,
		getErrors: getErrors,
		errorDaily: errorDaily
	}

}(activesService));

localStorage.dev = true;
